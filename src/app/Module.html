<div class='module mdl-card mdl-shadow--2dp'>
	<header>
		<div class="mdl-textfield mdl-js-textfield">
			<input class="mdl-textfield__input" value='{{module.name}}' placeholder='foo.js'>
		</div>
		<button class='mdl-button mdl-js-button' on-tap='fire("remove", index)'>remove</button>
	</header>

	<textarea value='[[module.code]]'/>
</div>

<style>
	.module {
		padding: 5px;
		margin: 0 auto 10px auto;
		width: calc( 100% - 10px );
		min-height: 100px;
	}

	header {
		width: 100%;
		padding: 0 5em 10px 0;
	}

	input {
		width: 100%;
	}

	button {
		position: absolute;
		top: 15px;
		right: 0;
	}

	textarea {
		width: 100%;
		height: 100px;
	}

	.CodeMirror {
		height: auto;
	}

	.CodeMirror-scroll {
		max-height: 80vh;
	}
</style>

<script>
	import tap from 'ractive-events-tap';

	component.exports = {
		onrender () {
			this.on( 'remove', index => this.parent.removeModule( index ) );

			let updating = false;

			const editor = CodeMirror.fromTextArea( this.find( 'textarea' ), {
				indentWithTabs: true,
				tabSize: 2,
				lineNumbers: true,
				lineWrapping: true
			});

			editor.on( 'change', instance => {
				if ( !updating ) {
					updating = true;
					this.set( 'module.code', instance.getValue() );
					updating = false;
				}
			});

			this.observe( 'module.code', code => {
				if ( !updating && code != null ) {
					updating = true;
					editor.setValue( code );
					updating = false;
				}
			});
		},

		events: { tap }
	};
</script>
